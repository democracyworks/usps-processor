box: wercker-labs/docker
build:
  steps:
    - add-to-known_hosts:
        hostname: github.com
    - mktemp:
        envvar: GITHUB_DEPLOY_KEY_PATH
    - create-file:
        name: write github deploy key
        filename: $GITHUB_DEPLOY_KEY_PATH
        content: $GITHUB_DEPLOY_PRIVATE
        overwrite: true
        hide-from-log: true
    - script:
        name: configure ssh key for github
        code: |
          echo -e "Host env-configs\n  HostName github.com\n  User git\n  IdentityFile $GITHUB_DEPLOY_KEY_PATH" >> ~/.ssh/config
    - script:
        name: fetch configs
        code: |
          git clone -b $CONFIG_BRANCH --depth 1 --single-branch $CONFIG_REPO env-configs
    - script:
        name: export and save image tag
        code: |
          export IMAGE_TAG=$WERCKER_GIT_BRANCH-`git rev-parse --short $WERCKER_GIT_COMMIT`
          echo $IMAGE_TAG > $WERCKER_OUTPUT_DIR/image_tag
    - script:
        name: build the container
        code: |
          docker build -t quay.io/democracyworks/usps-processor:$IMAGE_TAG .
    - script:
        name: run tests
        code: |
          docker run -e LEIN_USERNAME=$LEIN_USERNAME -e LEIN_PASSWORD=$LEIN_PASSWORD quay.io/democracyworks/usps-processor:$IMAGE_TAG lein test
    - script:
        name: login to quay.io
        hide-from-log: true
        code: |
          echo $QUAY_DOCKERCFG > $HOME/.dockercfg
    - script:
        name: push the container to the private registry
        code: |
          docker push quay.io/democracyworks/usps-processor
deploy:
  steps:
    - add-to-known_hosts:
        hostname: vpc-gw.turbovote.org
    - add-to-known_hosts:
        hostname: github.com
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $DEPLOY_PRIVATE_KEY
        overwrite: true
        hide-from-log: true
    - script:
        name: setup ssh tunnels to docker hosts
        code: |
          ssh -i $PRIVATEKEY_PATH ec2-user@vpc-gw.turbovote.org -L2222:docker1-int.turbovote.org:22 -f -N
          ssh -i $PRIVATEKEY_PATH ec2-user@vpc-gw.turbovote.org -L2223:docker2-int.turbovote.org:22 -f -N
    - script:
        name: restore image identifier from build
        code: |
          export IMAGE_TAG=`cat $WERCKER_ROOT/image_tag`
    - script:
        name: run new containers
        code: |
          ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2222 deploy@localhost "docker pull quay.io/democracyworks/usps-processor && docker run -e ENVIRONMENT=$DEPLOY_ENVIRONMENT -e LEIN_USERNAME=$LEIN_USERNAME -e LEIN_PASSWORD=$LEIN_PASSWORD quay.io/democracyworks/usps-processor:$IMAGE_TAG"
          ssh -i $PRIVATEKEY_PATH -o "StrictHostKeyChecking no" -p 2223 deploy@localhost "docker pull quay.io/democracyworks/usps-processor && docker run -e ENVIRONMENT=$DEPLOY_ENVIRONMENT -e LEIN_USERNAME=$LEIN_USERNAME -e LEIN_PASSWORD=$LEIN_PASSWORD quay.io/democracyworks/usps-processor:$IMAGE_TAG"
    - cmshea/immutant-deploy@0.0.17
